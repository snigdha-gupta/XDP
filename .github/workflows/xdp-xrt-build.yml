name: XDP Build Test

on:
  # For testing - trigger on push to specific branch
  push:
    branches: [ test-ci ]  # test branch
  # PR trigger for production use
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches: [ master ]

jobs:
  build-xrt-alveo:
  # For testing, always run on push. 
  # Only run if the PR has 'build-alveo' label
    if: |
      github.event_name == 'push' || 
      contains(github.event.pull_request.labels.*.name, 'build-alveo') 
    runs-on: ubuntu-latest # or ubuntu-20.04 or something else?
    timeout-minutes: 60
    
    steps:
    - name: Checkout XDP PR
      uses: actions/checkout@v4
      with:
        path: xdp-pr
        fetch-depth: 0
        
    - name: Clone XRT Repository
      run: |
        git clone https://github.com/Xilinx/XRT.git XRT
        cd XRT
        git submodule update --init --recursive
        
    - name: Apply XDP PR Changes to XRT
      run: |
        XDP_PATH="XRT/src/runtime_src/xdp"
        echo "Applying XDP changes to: $XDP_PATH"
        rm -rf $XDP_PATH/*
        cp -r xdp-pr/* $XDP_PATH/
        
    - name: Setup Build Environment Using XRT Scripts
      run: |
        cd XRT/src/runtime_src/tools/scripts
        chmod +x xrtdeps.sh
        sudo ./xrtdeps.sh
        # Install cross-compilation tools for edge builds
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          crossbuild-essential-arm64
        
    - name: Build XRT for Alveo
      run: |
        cd XRT/build
        chmod +x build.sh
        ./build.sh -noinit -noert
        
    - name: Validate build
      run: |
        if [ -f "XRT/build/Release/opt/xilinx/xrt/lib/libxrt_core.so" ]; then
          echo "✓ Build successful"
        else
          echo "✗ Build failed"
          exit 1
        fi
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: xrt-alveo-build-${{ github.run_number }}
        path: XRT/build/Release/opt/xilinx/xrt/lib/*.so
        retention-days: 1
        
  # Future job for edge builds
  build-xrt-edge:
    if: contains(github.event.pull_request.labels.*.name, 'build-edge')
    runs-on: ubuntu-latest
    steps:
      - name: Placeholder for edge build
        run: echo "Edge build would go here"
        
  # Future job for client builds
  build-xrt-client:
    if: contains(github.event.pull_request.labels.*.name, 'build-client')
    runs-on: ubuntu-latest
    steps:
      - name: Placeholder for client build
        run: echo "Client build would go here"

  # Future job for ve2 builds  
  build-xrt-ve2:
    if: contains(github.event.pull_request.labels.*.name, 'build-ve2')
    runs-on: ubuntu-latest
    steps:
      - name: Placeholder for ve2 build
        run: echo "VE2 build would go here"
